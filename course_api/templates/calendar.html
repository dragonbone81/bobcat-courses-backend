{% extends 'base.html' %}
{% load time_converter %}
{% block imports %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.15/js/bootstrap-multiselect.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mouse0270-bootstrap-notify/3.1.7/bootstrap-notify.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.15/css/bootstrap-multiselect.css"
          rel="stylesheet"/>
{% endblock %}

{% block preview_title %}Schedule Search{% endblock %}
{% block title %}Schedule Search {% endblock %}
{% block content %}

    <div class="container-fluid">
        <div>
            <h2>Search for Classes</h2>
            <form method="post" id="class_form">
                {% csrf_token %}
                <div class="form-row align-items-center">
                    <div class="col-auto form-inline" style="padding: 5px;">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend input-group-prepend-sm">
                                <span class="input-group-text"><label for="term">Term</label></span>
                            </div>
                            <select class="form-control" id="term" name="term" required>
                                <option selected value="201830">Fall 2018</option>
                                <option value="201810">Spring 2018</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm">
                        <select id="courses" class="js-example-basic-single" name="courses" multiple="multiple"
                                style="width: 100%" required>
                        </select>
                    </div>
                </div>
                <div class="form-row align-items-center">
                    <div class="col-auto form-inline" style="padding: 5px;">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><label for="earliest">Earliest Time</label></span>
                            </div>
                            <select class="form-control" id="earliest" name="earliest" required>
                                <option selected value="any">Any</option>
                                <option value="800">8:00am</option>
                                <option value="830">8:30am</option>
                                <option value="900">9:00am</option>
                                <option value="930">9:30am</option>
                                <option value="1000">10:00am</option>
                                <option value="1030">10:30am</option>
                                <option value="1100">11:00am</option>
                                <option value="1130">11:30am</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-auto form-inline" style="padding: 5px;">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><label for="latest">Latest Time</label></span>
                            </div>
                            <select class="form-control" id="latest" name="latest" required>
                                <option selected value="any">Any</option>
                                <option value="1700">5:00pm</option>
                                <option value="1730">5:30pm</option>
                                <option value="1800">6:00pm</option>
                                <option value="1830">6:30pm</option>
                                <option value="1900">7:00pm</option>
                                <option value="1930">7:30pm</option>
                                <option value="2000">8:00pm</option>
                                <option value="2030">8:30pm</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-auto form-inline" style="padding: 5px;">
                        <div class="input-group input-group-sm">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><label for="filters">Filters</label></span>
                            </div>
                            <select class="form-control" name="filters" id="filters" multiple>
                                <optgroup class="gaps" label="Class Gaps">
                                    <option value="gaps_min">Minimize Gaps</option>
                                    <option value="gaps_max">Maximize Gaps</option>
                                </optgroup>
                                <optgroup class="days" label="Days">
                                    <option value="min_days">Minimize Days</option>
                                    <option value="max_days">Maximize Days</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="col-auto" style="padding: 5px;">
                        <button class="btn btn-md btn-success" type="submit" id="submit_b">Get Schedules
                        </button>
                    </div>
                    {% if schedules %}
                        <div class="col-auto" style="padding: 5px;">
                            <span class="d-inline-block" tabindex="0"
                                  {% if not request.user.is_authenticated %}data-toggle="tooltip"
                                  title="Login to save schedule"{% endif %}>
                              <button class="btn btn-md btn-info" type="button"
                                      {% if not request.user.is_authenticated %}style="pointer-events: none;"
                                      disabled{% endif %} onclick="class_form_submit(this.form)">
                                  Save Schedule
                              </button>
                            </span>
                        </div>
                        <div class="col-auto" style="padding: 5px;">
                            <span class="d-inline-block" tabindex="0" data-toggle="tooltip"
                                  title="Registration is not yet open">
                              <button class="btn btn-md btn-info" type="button" style="pointer-events: none;"
                                      disabled>
                                  Register
                              </button>
                            </span>
                        </div>
                        {#                        TODO disable untill registration#}
                        {#                        <div class="col-auto" style="padding: 5px;">#}
                        {#                            <button class="btn btn-lg btn-warning" type="button" id="register" name="register"#}
                        {#                                    data-toggle="modal" data-target="#register_modal">Register#}
                        {#                            </button>#}
                        {#                        </div>#}
                    {% endif %}
                </div>
            </form>

        </div>
        {% if schedules %}
            <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="schedule_span">Schedule </span>
                </div>
                <div class="input-group-append">
                    <button class="btn btn-outline-primary" aria-label="Small" type="button"
                            onclick="toggle_tables('back', 5)"><i
                            class="fa fa-angle-double-left"></i> Back 5
                    </button>
                </div>
                <div class="input-group-append">
                    <button class="btn btn-outline-primary" aria-label="Small" type="button"
                            onclick="toggle_tables('back', 1)"><i
                            class="fa fa-arrow-left"></i> Previous
                    </button>
                </div>
                <div class="input-group-append">
                    <button class="btn btn-outline-primary" aria-label="Small" type="button"
                            onclick="toggle_tables('forward', 1)">Next
                        <i
                                class="fa fa-arrow-right"></i>
                    </button>
                </div>
                <div class="input-group-append">
                    <button class="btn btn-outline-primary" aria-label="Small" type="button"
                            onclick="toggle_tables('forward', 5)"><i
                            class="fa fa-angle-double-right"></i> Skip 5
                    </button>
                </div>
                <div class="input-group-append">
                    <span class="input-group-text">Total Schedules : {{ total_schedules }} </span>
                </div>


            </div>
        {% else %}
            {% if not new %}
                <div class="alert alert-danger" role="alert">
                    <strong>No available Schedules!</strong> There are conflicts or classes are full :*(
                </div>
            {% endif %}
        {% endif %}
        {% for calendar in schedules %}

            <div class="row" id="{{ calendar.unique_name }}" hidden>
                <div class="table-responsive col-md-8 col-lg-7">
                    <table class="table table-bordered table-responsive table-sm" style="font-size: smaller">
                        <thead>
                        <tr class="text-center">
                            <th>Schedule</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                            <th>Thursday</th>
                            <th>Friday</th>
                        </tr>
                        </thead>
                        <tbody>
                        <script>

                        </script>
                        {% for time, data in calendar.items %}
                            {% if time == "unique_name" %}
                            {% else %}
                                <tr class="text-center">
                                    <td>{{ times|get_item:time }}</td>

                                    {% for day, day_data in data.items %}
                                        {% if day_data.crn %}
                                            {% if day_data.next == False %}

                                                        <td bgcolor="{{ day_data.color }}"
                                                            style="border: 2px solid lightgrey;"
                                                            rowspan="{{ day_data.length }}">

                                                            <div><u>{{ day_data.course_id }}</u></div>
                                                            <div>Section: {{ day_data.type }}</div>
                                                            <div>Hours: {{ day_data.hours }}</div>
                                                            <div>CRN: {{ day_data.crn }}</div>
                                                        </td>
                                            {% elif day_data.next == True %}
                                            {% endif %}
                                        {% else %}
                                            <td></td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                            {% endif %}
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="col-lg-3">
                    <div class="card" style="width: 18rem;">
                        <div class="card-header">
                            <h6>My Classes:</h6>

                        </div>
                        <ul class="list-group list-group-flush">
                            {% with calendar.unique_name as unique_name %}
                                {% with all_schedule_crns|get_item_dict:unique_name as course_crn_data %}
                                    {% for course in course_crn_data.data %}
                                        <li class="list-group-item"
                                            style="background-color: {{ course.color }}"><b>{{ course.course_id }}</b>: {{ course.crn }}</li>
                                    {% endfor %}



                                    <div class="modal fade" id="register_modal{{ calendar.unique_name }}" tabindex="-1"
                                         role="dialog"
                                         aria-labelledby="register_modal{{ calendar.unique_name }}"
                                         aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Register with CAS</h5>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                            aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    This will register your for the currently selected classes (list
                                                    below).<br>
                                                    You will need to provide us with your UCMerced username (not email)
                                                    and password. Yes the one for
                                                    CatCourses.<br>
                                                    We promise not to store this however if you have any doubt don't use
                                                    this and just copy the CRN
                                                    numbers below :)<br><br>
                                                    <i>You will be registered for these courses: </i><br>
                                                    {% for course in course_crn_data.data %}
                                                        {{ course.crn }},
                                                    {% endfor %}
                                                    <form class="px-4 py-3"
                                                          id="register_form{{ unique_name }}" action="">
                                                        {% csrf_token %}
                                                        <div class="form-group">
                                                            <label for="username">Username</label>
                                                            <input type="text"
                                                                   class="form-control"
                                                                   placeholder="Username"
                                                                   name="username" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="password">Password</label>
                                                            <input type="password"
                                                                   class="form-control"
                                                                   placeholder="Password"
                                                                   name="password" required>
                                                        </div>
                                                        <button type="submit"
                                                                class="btn btn-warning">
                                                            Register
                                                        </button>
                                                    </form>
                                                    <script>
                                                        var form_id = "#" + "register_form{{ unique_name }}";
                                                        $(form_id).submit(function (e) {
                                                            e.preventDefault();
                                                            var url = "/api/courses/course-register/"; // the script where you handle the form input.

                                                            var crns = [];
                                                            {% for course in course_crn_data.data %}
                                                                crns.push({{ course.crn }});
                                                            {% endfor %}
                                                            var data = $(this).serializeArray();
                                                            data.push({name: "crns", value: crns}, {
                                                                name: "term",
                                                                value: "{{old_data.term}}"
                                                            });
                                                            $.ajax({
                                                                type: "POST",
                                                                url: url,
                                                                data: data, // serializes the form's elements.
                                                                success: function (data) {
                                                                    $(function () {
                                                                        $(current_register_id).modal('hide');
                                                                        $('#dialog').modal('show');
                                                                    });
                                                                }
                                                            });
                                                        });
                                                    </script>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endwith %}
                            {% endwith %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    <script>
        var all_crns = {};
        {% for course_id, data in all_schedule_crns.items %}
            var course_id = "{{ course_id }}";
            var crns = [];
            {% for crn_data in data %}
                var crn = "{{ crn_data.crn }}";
                crns.push(crn);
            {% endfor %}
            all_crns[course_id] = crns;
        {% endfor %}
        var current_crns = [];
        var current_id = "{{ all_schedule_ids.0 }}";
        var current_register_id = "#register_modal" + current_id;
        var current_schedule = 0;
        var all_ids = [];
        {%  for course_id in all_schedule_ids  %}
            all_ids.push("{{course_id}}");
        {% endfor %}
        $('#schedule_span').text("Schedule " + (current_schedule + 1));
        current_crns = all_crns[current_id];

        // In your Javascript (external .js resource or <script> tag)
        function toggle_tables(way, num) {

            var table_id = '#' + current_id;
            $(table_id).attr('hidden', true);
            if (way === 'forward') {
                if (current_schedule + num > ({{ total_schedules }}-1)) {
                    current_schedule = 0;
                }
                else {
                    current_schedule += num;
                }
            }
            if (way === 'back') {
                if (current_schedule - num < 0) {
                    current_schedule = {{ total_schedules }}-1;
                }
                else {
                    current_schedule -= num;
                }
            }
            current_id = all_ids[current_schedule];
            table_id = '#' + current_id;
            current_register_id = "#register_modal" + current_id;
            $("#register").attr('data-target', current_register_id);
            $(table_id).removeAttr('hidden');
            $('#schedule_span').text("Schedule " + (current_schedule + 1));
            current_crns = all_crns[current_id];

        }

        $('.js-example-basic-single').select2({
            placeholder: "Search for Classes",
            width: 'resolve',
            ajax: {
                url: '/api/courses/course-search/',
                data: function (params) {
                    return {
                        course: params.term,
                        term: $('#term').val()
                    };
                },
                processResults: function (data) {
                    var results = [];
                    data.forEach(function (course) {
                        results.push({
                            id: course,
                            text: course
                        })
                    });
                    return {
                        results: results
                    };
                }
            }
        });
        $('#filters').multiselect({
            onChange: function (options, checked) {
                var $option = $(options);
                if ($option.length === 1) {

                    var $group = $option.parent('optgroup');
                    var $options = $('option', $group);
                    $options = $options.filter(':selected');

                    if (checked && $options.length > 1) {
                        $("#filters").multiselect('deselect', $option.val());
                    }
                }
            }

        });
        var filters = [];
        {% for filter in old_data.filters %}
            filters.push("{{ filter }}");
        {% endfor %}
        $("#filters").multiselect('select', filters);
        {% if old_data.latest %}
            $("#latest").val("{{ old_data.latest }}");
        {% endif %}
        {% if old_data.earliest %}
            $("#earliest").val("{{ old_data.earliest }}");
        {% endif %}
        {% if old_data.term %}
            $("#term").val("{{ old_data.term }}");
        {% endif %}
        {% if schedules %}
            var table_id = '#' + current_id;
            $(table_id).removeAttr('hidden');
        {% endif %}
        {% if old_data.selected_classes %}
            {% for course in old_data.selected_classes %}
                var option = new Option("{{ course }}", "{{ course }}");
                option.selected = true;

                $("#courses").append(option);

            {% endfor %}
            $("#courses").trigger("change");
        {% endif %}


        current_register_id = "#register_modal" + current_id;
        $("#register").attr('data-target', current_register_id);


        $(document).ready(function () {


        });
        $('[data-toggle="tooltip"]').tooltip();

        function class_form_submit(form) {
            var data = $(form).serializeArray();
            data.push({name: "crns", value: current_crns});
            var url = "/api/users/save-schedule/"; // the script where you handle the form input.
            $.ajax({
                type: "POST",
                url: url,
                data: data, // serializes the form's elements.
                success: function (data) {
                    var message = {};
                    if (data.error) {
                        message.error = true;
                        message.title = data.error;
                        message.message = "";
                        message.type = 'warning';
                    }
                    if (data.success) {
                        message.success = true;
                        message.title = data.success;
                        message.message = "Go to Saved Schedules to view it";
                        message.type = 'info';
                    }
                    $(function () {
                        $.notify({
                            // options
                            title: message.title + '<br>',
                            message: message.message
                        }, {
                            // settings
                            type: message.type
                        });
                    });
                }
            });
        }
    </script>
    <div id="dialog" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registration Complete</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <!-- dialog body -->
                <div class="modal-body">

                    You have been registered, go to MyRegistration to double check :)
                    <a target="_blank" href="https://mystudentrecord.ucmerced.edu/pls/PROD/bwskfreg.P_AltPin">https://mystudentrecord.ucmerced.edu/pls/PROD/bwskfreg.P_AltPin</a>
                </div>
                <!-- dialog buttons -->
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <script>
        $("#dialog").on("show", function () {    // wire up the OK button to dismiss the modal when shown
            $("#dialog a.btn").on("click", function (e) {
                $("#myModal").modal('hide');     // dismiss the dialog
            });
        });
        $("#dialog").on("hide", function () {    // remove the event listeners when the dialog is dismissed
            $("#dialog a.btn").off("click");
        });

        $("#dialog").on("hidden", function () {  // remove the actual elements from the DOM when fully hidden
            $("#dialog").remove();
        });

        $("#dialog").modal({                    // wire up the actual modal functionality and show the dialog
            "backdrop": "static",
            "keyboard": true,
            "show": false                     // ensure the modal is shown immediately
        });
    </script>
{% endblock %}
